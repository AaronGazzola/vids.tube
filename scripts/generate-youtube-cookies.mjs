#!/usr/bin/env node

import { exec } from 'child_process';
import { promises as fs } from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

console.log('YouTube Cookie Generator for vids.tube');
console.log('=======================================\n');

console.log('This script will help you generate cookies for YouTube authentication.\n');
console.log('You have two options:\n');
console.log('1. Export cookies from your browser (recommended)');
console.log('2. Use yt-dlp to extract cookies from browser automatically\n');

const cookiesPath = path.join(__dirname, '..', 'worker', 'cookies', 'cookies.txt');

async function ensureCookiesDir() {
  const cookiesDir = path.dirname(cookiesPath);
  await fs.mkdir(cookiesDir, { recursive: true });
}

async function extractFromBrowser() {
  console.log('\nAttempting to extract cookies from browser...');
  console.log('Supported browsers: chrome, firefox, safari, edge\n');

  const browsers = ['chrome', 'firefox', 'safari', 'edge'];

  for (const browser of browsers) {
    console.log(`Trying ${browser}...`);

    try {
      await new Promise((resolve, reject) => {
        exec(`yt-dlp --cookies-from-browser ${browser} --cookies ${cookiesPath} --skip-download https://www.youtube.com/watch?v=dQw4w9WgXcQ`,
          (error, stdout, stderr) => {
            if (error) {
              console.log(`  Failed: ${stderr.split('\n')[0]}`);
              reject(error);
            } else {
              console.log(`  Success! Cookies exported from ${browser}`);
              resolve(stdout);
            }
          });
      });
      return true;
    } catch (error) {
      continue;
    }
  }

  return false;
}

async function generateNetscapeFormat() {
  console.log('\nGenerating empty Netscape format cookies file...');
  console.log('You will need to manually add your YouTube cookies.\n');

  const template = `# Netscape HTTP Cookie File
# This file is generated by generate-youtube-cookies.mjs
# Add your YouTube cookies below in the following format:
# domain\tflag\tpath\tsecure\texpiration\tname\tvalue

# Example (replace with actual values):
# .youtube.com\tTRUE\t/\tTRUE\t1234567890\tCOOKIE_NAME\tCOOKIE_VALUE
`;

  await fs.writeFile(cookiesPath, template);
  console.log(`Cookies template created at: ${cookiesPath}`);
  console.log('\nTo get cookies manually:');
  console.log('1. Open YouTube in your browser and sign in');
  console.log('2. Open browser developer tools (F12)');
  console.log('3. Go to Application/Storage -> Cookies');
  console.log('4. Export important cookies like: SID, HSID, SSID, APISID, SAPISID, LOGIN_INFO');
  console.log('5. Add them to the cookies.txt file in Netscape format\n');
}

async function main() {
  try {
    await ensureCookiesDir();

    const success = await extractFromBrowser();

    if (!success) {
      console.log('\nAutomatic extraction failed. Generating template file...');
      await generateNetscapeFormat();
    }

    console.log('\n=== Next Steps ===');
    console.log('1. Verify cookies file at:', cookiesPath);
    console.log('2. Set Railway environment variable:');
    console.log('   YT_COOKIES_PATH=/app/cookies/cookies.txt');
    console.log('3. Optionally set a custom User-Agent:');
    console.log('   YT_USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"');
    console.log('4. Deploy to Railway\n');

  } catch (error) {
    console.error('Error:', error.message);
    process.exit(1);
  }
}

main();